name: 'CodeQL SAST Scanner'
description: 'Static Application Security Testing using GitHub CodeQL'

inputs:
  language:
    description: 'Programming language (java, javascript, python, csharp, go, ruby)'
    required: true
  build-command:
    description: 'Build command for compiled languages (Maven, Gradle, etc.)'
    required: true

outputs:
  results-count:
    description: 'Number of security issues found'
    value: ${{ steps.results.outputs.count }}
  critical-count:
    description: 'Number of critical/error issues'
    value: ${{ steps.results.outputs.critical }}
  high-severity-count:
    description: 'Number of high severity issues'
    value: ${{ steps.results.outputs.high-severity }}
  medium-severity-count:
    description: 'Number of medium severity issues'
    value: ${{ steps.results.outputs.medium-severity }}
  low-severity-count:
    description: 'Number of low severity issues'
    value: ${{ steps.results.outputs.low-severity }}
  database-path:
    description: 'Path to CodeQL database'
    value: ${{ steps.init.outputs.codeql-path }}
  sarif-file:
    description: 'Path to SARIF results file'
    value: ${{ steps.results.outputs.sarif-file }}

runs:
  using: 'composite'
  steps:
    - name: Initialize CodeQL
      id: init
      uses: github/codeql-action/init@v3
      with:
        languages: ${{ inputs.language }}

    - name: Setup Maven for Java Analysis
      if: inputs.language == 'java-kotlin'
      shell: bash
      run: |
        echo "â˜• Setting up Maven environment for CodeQL analysis..."
        if [ -f "pom.xml" ]; then
          echo "ðŸ“¦ Resolving Maven dependencies..."
          mvn dependency:resolve -B -q
        fi

    - name: Build Application for Analysis
      if: inputs.language == 'java-kotlin'
      shell: bash
      run: |
        echo "ðŸ—ï¸ Building application for CodeQL analysis..."
        ${{ inputs.build-command }}
        
        # Verify build artifacts
        if [ -d "target/classes" ]; then
          echo "âœ… Build successful - classes found in target/classes"
          echo "ðŸ“Š Compiled classes count: $(find target/classes -name "*.class" | wc -l)"
        else
          echo "âš ï¸ Warning: No compiled classes found in target/classes"
        fi


    - name: Perform CodeQL Analysis
      id: analyze
      uses: github/codeql-action/analyze@v3
      with:
        category: "codeql-${{ inputs.language }}"

    - name: Parse CodeQL Results
      id: results
      shell: bash
      run: |
        echo "ï¿½ Parsing CodeQL analysis results..."
        
        # Find the SARIF file
        SARIF_FILE=""
        if [ -d "${{ steps.analyze.outputs.sarif-output }}" ]; then
          SARIF_FILE=$(find "${{ steps.analyze.outputs.sarif-output }}" -name "*.sarif" -type f | head -1)
        fi
        
        if [ -n "$SARIF_FILE" ] && [ -f "$SARIF_FILE" ]; then
          echo "ï¿½ Found SARIF file: $SARIF_FILE"
          cat $SARIF_FILE
          # Debug: Show SARIF structure first
          echo "ðŸ” Full SARIF structure analysis:"
          echo "ðŸ“Š Sample result structure:"
          jq '.runs[].results[0] | keys' "$SARIF_FILE" 2>/dev/null || echo "Could not get result keys"
          echo "ðŸ“Š Sample rule structure:"
          jq '.runs[].tool.driver.rules[0] | keys' "$SARIF_FILE" 2>/dev/null || echo "Could not get rule keys"
          echo "ðŸ“Š First few results:"
          jq '.runs[].results[0:2] | .[] | {ruleId: .ruleId, level: .level, kind: .kind, properties: .properties}' "$SARIF_FILE" 2>/dev/null || echo "Could not analyze basic structure"
          
          # Look for severity in rules section (CodeQL often stores it there)
          echo "ðŸ“Š Rule severity mapping:"
          jq '.runs[].tool.driver.rules[] | {id: .id, defaultLevel: (.properties."problem.severity" // .properties.severity // .level // "unknown")}' "$SARIF_FILE" 2>/dev/null | head -5 || echo "Could not get rule severities"
          
          # Count total results
          TOTAL_RESULTS=$(jq '[.runs[].results] | add | length' "$SARIF_FILE" 2>/dev/null || echo "0")
          
          # Count by CodeQL severity levels (error, warning, note, info)
          ERROR_COUNT=$(jq '[.runs[].results[] | select(.level == "error")] | length' "$SARIF_FILE" 2>/dev/null || echo "0")
          WARNING_COUNT=$(jq '[.runs[].results[] | select(.level == "warning")] | length' "$SARIF_FILE" 2>/dev/null || echo "0")
          NOTE_COUNT=$(jq '[.runs[].results[] | select(.level == "note")] | length' "$SARIF_FILE" 2>/dev/null || echo "0")
          INFO_COUNT=$(jq '[.runs[].results[] | select(.level == "info")] | length' "$SARIF_FILE" 2>/dev/null || echo "0")
          
          # Build rule severity map and count by severity
          # Create a map of ruleId to severity from the rules section
          HIGH_SEVERITY=0
          MEDIUM_SEVERITY=0
          LOW_SEVERITY=0
          
          # Method 1: Direct severity from result properties
          HIGH_SEVERITY_DIRECT=$(jq '[.runs[].results[] | select(.properties.severity == "high" or .properties."problem.severity" == "high")] | length' "$SARIF_FILE" 2>/dev/null || echo "0")
          MEDIUM_SEVERITY_DIRECT=$(jq '[.runs[].results[] | select(.properties.severity == "medium" or .properties."problem.severity" == "medium")] | length' "$SARIF_FILE" 2>/dev/null || echo "0")
          LOW_SEVERITY_DIRECT=$(jq '[.runs[].results[] | select(.properties.severity == "low" or .properties."problem.severity" == "low")] | length' "$SARIF_FILE" 2>/dev/null || echo "0")
          
          # Method 2: Map from rules to results
          HIGH_SEVERITY_RULES=$(jq '
            [
              .runs[] as $run |
              ($run.tool.driver.rules | map(select((.properties."problem.severity" // .properties.severity // .level) == "high") | .id)) as $highRules |
              $run.results[] | 
              select(.ruleId as $rid | $highRules | index($rid))
            ] | length' "$SARIF_FILE" 2>/dev/null || echo "0")
          
          MEDIUM_SEVERITY_RULES=$(jq '
            [
              .runs[] as $run |
              ($run.tool.driver.rules | map(select((.properties."problem.severity" // .properties.severity // .level) == "medium") | .id)) as $mediumRules |
              $run.results[] | 
              select(.ruleId as $rid | $mediumRules | index($rid))
            ] | length' "$SARIF_FILE" 2>/dev/null || echo "0")
          
          LOW_SEVERITY_RULES=$(jq '
            [
              .runs[] as $run |
              ($run.tool.driver.rules | map(select((.properties."problem.severity" // .properties.severity // .level) == "low") | .id)) as $lowRules |
              $run.results[] | 
              select(.ruleId as $rid | $lowRules | index($rid))
            ] | length' "$SARIF_FILE" 2>/dev/null || echo "0")
          
          # Use the maximum of both methods
          HIGH_SEVERITY=$((HIGH_SEVERITY_DIRECT > HIGH_SEVERITY_RULES ? HIGH_SEVERITY_DIRECT : HIGH_SEVERITY_RULES))
          MEDIUM_SEVERITY=$((MEDIUM_SEVERITY_DIRECT > MEDIUM_SEVERITY_RULES ? MEDIUM_SEVERITY_DIRECT : MEDIUM_SEVERITY_RULES))
          LOW_SEVERITY=$((LOW_SEVERITY_DIRECT > LOW_SEVERITY_RULES ? LOW_SEVERITY_DIRECT : LOW_SEVERITY_RULES))
          
          # Set outputs
          echo "count=$TOTAL_RESULTS" >> $GITHUB_OUTPUT
          echo "critical=$ERROR_COUNT" >> $GITHUB_OUTPUT
          echo "warning=$WARNING_COUNT" >> $GITHUB_OUTPUT
          echo "info=$((NOTE_COUNT + INFO_COUNT))" >> $GITHUB_OUTPUT
          echo "high-severity=$HIGH_SEVERITY" >> $GITHUB_OUTPUT
          echo "medium-severity=$MEDIUM_SEVERITY" >> $GITHUB_OUTPUT
          echo "low-severity=$LOW_SEVERITY" >> $GITHUB_OUTPUT
          echo "sarif-file=$SARIF_FILE" >> $GITHUB_OUTPUT
          
          echo "ðŸ” CodeQL Analysis Summary:"
          echo "  - Total Issues: $TOTAL_RESULTS"
          echo "  - Critical/Error: $ERROR_COUNT"
          echo "  - Warning: $WARNING_COUNT" 
          echo "  - Note/Info: $((NOTE_COUNT + INFO_COUNT))"
          echo "  - High Severity: $HIGH_SEVERITY (Direct: $HIGH_SEVERITY_DIRECT, Rules: $HIGH_SEVERITY_RULES)"
          echo "  - Medium Severity: $MEDIUM_SEVERITY (Direct: $MEDIUM_SEVERITY_DIRECT, Rules: $MEDIUM_SEVERITY_RULES)"
          echo "  - Low Severity: $LOW_SEVERITY (Direct: $LOW_SEVERITY_DIRECT, Rules: $LOW_SEVERITY_RULES)"
          
          # Show detailed breakdown of all issues with rule lookup
          if [ "$TOTAL_RESULTS" -gt 0 ]; then
            echo ""
            echo "ðŸ“‹ Detailed Issues Found:"
            jq -r '
              .runs[] as $run |
              ($run.tool.driver.rules | map({key: .id, value: (.properties."problem.severity" // .properties.severity // .level // "unknown")}) | from_entries) as $ruleSeverities |
              $run.results[] | 
              "- [\(.level // "null")] \(.ruleId): \(.message.text) (Rule Severity: \($ruleSeverities[.ruleId] // "N/A"))"
            ' "$SARIF_FILE" 2>/dev/null || echo "Could not parse issue details"
          fi
          
          # Debug: Show unique levels and severities found  
          echo ""
          echo "ðŸ”§ Debug - Unique levels found in results:"
          jq -r '.runs[].results[] | .level // "null"' "$SARIF_FILE" 2>/dev/null | sort | uniq -c || echo "Could not extract levels"
          echo "ðŸ”§ Debug - Unique severities found in result properties:"
          jq -r '.runs[].results[] | .properties.severity // .properties."problem.severity" // "none"' "$SARIF_FILE" 2>/dev/null | sort | uniq -c || echo "Could not extract result severities"
          echo "ðŸ”§ Debug - Unique severities found in rules:"
          jq -r '.runs[].tool.driver.rules[] | .properties."problem.severity" // .properties.severity // .level // "none"' "$SARIF_FILE" 2>/dev/null | sort | uniq -c || echo "Could not extract rule severities"
        else
          echo "âš ï¸ No SARIF results file found"
          echo "count=0" >> $GITHUB_OUTPUT
          echo "critical=0" >> $GITHUB_OUTPUT
          echo "warning=0" >> $GITHUB_OUTPUT
          echo "info=0" >> $GITHUB_OUTPUT
          echo "high-severity=0" >> $GITHUB_OUTPUT
          echo "medium-severity=0" >> $GITHUB_OUTPUT
          echo "low-severity=0" >> $GITHUB_OUTPUT
        fi

    - name: Check Security Threshold
      if: inputs.fail-on-error == 'true'
      shell: bash
      run: |
        CRITICAL_COUNT="${{ steps.results.outputs.critical }}"
        if [ "$CRITICAL_COUNT" -gt 0 ]; then
          echo "âŒ Found $CRITICAL_COUNT critical security issues!"
          echo "Failing as requested by fail-on-error=true"
          exit 1
        else
          echo "âœ… No critical security issues found"
        fi

    - name: Generate Security Summary
      shell: bash
      run: |
        echo "## ðŸ” CodeQL SAST Analysis Results" >> $GITHUB_STEP_SUMMARY
        echo "- **Language**: ${{ inputs.language }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Build Command**: \`${{ inputs.build-command }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Total Issues**: ${{ steps.results.outputs.count || 'N/A' }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“Š By Level" >> $GITHUB_STEP_SUMMARY
        echo "- **Critical/Error**: ${{ steps.results.outputs.critical || 'N/A' }} ðŸš¨" >> $GITHUB_STEP_SUMMARY
        echo "- **Warning**: ${{ steps.results.outputs.warning || 'N/A' }} âš ï¸" >> $GITHUB_STEP_SUMMARY
        echo "- **Info**: ${{ steps.results.outputs.info || 'N/A' }} â„¹ï¸" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸŽ¯ By Severity" >> $GITHUB_STEP_SUMMARY
        echo "- **High**: ${{ steps.results.outputs.high-severity || 'N/A' }} ðŸ”´" >> $GITHUB_STEP_SUMMARY
        echo "- **Medium**: ${{ steps.results.outputs.medium-severity || 'N/A' }} ðŸŸ¡" >> $GITHUB_STEP_SUMMARY
        echo "- **Low**: ${{ steps.results.outputs.low-severity || 'N/A' }} ðŸŸ¢" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ steps.results.outputs.count }}" -gt 0 ]; then
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŽ¯ Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Check the **Security** tab for detailed findings" >> $GITHUB_STEP_SUMMARY
          echo "2. Review the uploaded SARIF artifacts" >> $GITHUB_STEP_SUMMARY
          echo "3. Address critical and high-severity issues first" >> $GITHUB_STEP_SUMMARY
        else
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŽ‰ **No security issues detected!**" >> $GITHUB_STEP_SUMMARY
        fi
