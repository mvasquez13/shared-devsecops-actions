name: 'Notify Grafana Cloud'
description: 'Send DevSecOps pipeline metrics and events to Grafana Cloud (Loki, Prometheus, Annotations)'
author: 'DevSecOps Team'

inputs:
  grafana-url:
    description: 'Grafana Cloud instance URL (for annotations)'
    required: true
    default: 'https://mibancotestgithub.grafana.net'
  loki-url:
    description: 'Loki endpoint URL (e.g., https://logs-prod-us-central1.grafana.net)'
    required: false
    default: ''
  prometheus-url:
    description: 'Prometheus endpoint URL (e.g., https://prometheus-prod-us-central1.grafana.net)'
    required: false
    default: 'https://prometheus-prod-56-prod-us-east-2.grafana.net'
  grafana-api-key:
    description: 'Grafana Cloud API key or service account token'
    required: true
  app-name:
    description: 'Application name'
    required: true
  app-version:
    description: 'Application version'
    required: true
  environment:
    description: 'Deployment environment (dev, staging, prod)'
    required: true
  build-status:
    description: 'Build status (success, failure)'
    required: true
  vulnerabilities-critical:
    description: 'Number of critical vulnerabilities'
    required: false
    default: '0'
  vulnerabilities-high:
    description: 'Number of high vulnerabilities'
    required: false
    default: '0'
  vulnerabilities-medium:
    description: 'Number of medium vulnerabilities'
    required: false
    default: '0'
  vulnerabilities-low:
    description: 'Number of low vulnerabilities'
    required: false
    default: '0'
  code-coverage:
    description: 'Code coverage percentage'
    required: false
    default: '0'
  execution-time:
    description: 'Pipeline execution time in seconds'
    required: false
    default: '0'
  enable-loki:
    description: 'Enable Loki log integration'
    required: false
    default: 'true'
  enable-prometheus:
    description: 'Enable Prometheus metrics integration'
    required: false
    default: 'true'
  enable-annotations:
    description: 'Enable Grafana annotations integration'
    required: false
    default: 'true'

outputs:
  status:
    description: 'Overall integration status'
    value: ${{ steps.grafana-integration.outputs.status }}
  loki-status:
    description: 'Loki integration status'
    value: ${{ steps.grafana-integration.outputs.loki-status }}
  prometheus-status:
    description: 'Prometheus integration status'
    value: ${{ steps.grafana-integration.outputs.prometheus-status }}
  annotations-status:
    description: 'Annotations integration status'
    value: ${{ steps.grafana-integration.outputs.annotations-status }}
  metrics-count:
    description: 'Number of metrics sent'
    value: ${{ steps.grafana-integration.outputs.metrics-count }}

runs:
  using: 'composite'
  steps:
    - name: 'Send Data to Grafana Cloud Stack'
      id: grafana-integration
      shell: bash
      env:
        GRAFANA_URL: ${{ inputs.grafana-url }}
        LOKI_URL: ${{ inputs.loki-url }}
        PROMETHEUS_URL: ${{ inputs.prometheus-url }}
        GRAFANA_API_KEY: ${{ inputs.grafana-api-key }}
      run: |
        echo "ðŸ“Š Grafana Cloud Modular Integration"
        
        # Current timestamp
        TIMESTAMP=$(date +%s)
        OVERALL_STATUS="success"
        LOKI_STATUS="disabled"
        PROMETHEUS_STATUS="disabled"
        ANNOTATIONS_STATUS="disabled"
        METRICS_COUNT=0
        
        # Auto-detect URLs if not provided
        if [ -z "${LOKI_URL}" ] && [ "${{ inputs.enable-loki }}" = "true" ]; then
          # Extract org from grafana URL and build Loki URL
          LOKI_URL="https://logs-prod-us-central1.grafana.net"
          echo "ðŸ” Auto-detected Loki URL: ${LOKI_URL}"
        fi
        
        if [ -z "${PROMETHEUS_URL}" ] && [ "${{ inputs.enable-prometheus }}" = "true" ]; then
          # Extract org from grafana URL and build Prometheus URL
          PROMETHEUS_URL="https://prometheus-prod-us-central1.grafana.net"
          echo "ðŸ” Auto-detected Prometheus URL: ${PROMETHEUS_URL}"
        fi
        
        echo ""
        echo "ðŸŽ¯ Grafana Cloud Stack Overview:"
        echo "  ðŸ“ Loki (Logs): Events, messages, pipeline context"
        echo "  ðŸ“Š Prometheus (Metrics): DevSecOps metrics via Python script"
        echo "  ðŸ“‹ Annotations: Timeline events in dashboards"
        echo ""
        echo "ðŸŒ Endpoint URLs:"
        echo "  ðŸ“ Loki: ${LOKI_URL}"
        echo "  ðŸ“Š Prometheus: ${PROMETHEUS_URL}"
        echo "  ðŸ“‹ Grafana: ${GRAFANA_URL}"
        echo ""
        echo "ðŸ”§ Integration Configuration:"
        echo "  ðŸ“ Loki: ${{ inputs.enable-loki }}"
        echo "  ðŸ“Š Prometheus: ${{ inputs.enable-prometheus }}"
        echo "  ðŸ“‹ Annotations: ${{ inputs.enable-annotations }}"
        echo ""
        
        # Loki Integration
        if [ "${{ inputs.enable-loki }}" = "true" ]; then
          echo "ðŸ“ Sending EVENTS to Grafana Loki..."
          LOKI_ENDPOINT="${LOKI_URL}/loki/api/v1/push"
          
          echo '{
            "streams": [
              {
                "stream": {
                  "app": "'${{ inputs.app-name }}'",
                  "version": "'${{ inputs.app-version }}'",
                  "environment": "'${{ inputs.environment }}'",
                  "source": "github-actions",
                  "pipeline": "devsecops"
                },
                "values": [
                  ["'${TIMESTAMP}'000000000", "ðŸš€ DevSecOps Pipeline: ${{ inputs.build-status }} | App: ${{ inputs.app-name }} v${{ inputs.app-version }} | Env: ${{ inputs.environment }}"],
                  ["'${TIMESTAMP}'000000001", "ðŸ” Security Results - Critical: ${{ inputs.vulnerabilities-critical }}, High: ${{ inputs.vulnerabilities-high }}, Medium: ${{ inputs.vulnerabilities-medium }}, Low: ${{ inputs.vulnerabilities-low }}"],
                  ["'${TIMESTAMP}'000000002", "ðŸ“Š Quality Metrics - Coverage: ${{ inputs.code-coverage }}% | Execution Time: ${{ inputs.execution-time }}s"]
                ]
              }
            ]
          }' > /tmp/loki-logs.json
          
          if curl -X POST \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${GRAFANA_API_KEY}" \
            -d @/tmp/loki-logs.json \
            "${LOKI_ENDPOINT}" \
            --silent --show-error; then
            echo "âœ… Events sent to Loki"
            LOKI_STATUS="success"
          else
            echo "âš ï¸ Loki integration failed"
            LOKI_STATUS="failed"
            OVERALL_STATUS="partial"
          fi
          
          rm -f /tmp/loki-logs.json
        else
          echo "â­ï¸ Loki integration disabled"
        fi
        
        # Prometheus Integration using send_data.py script
        if [ "${{ inputs.enable-prometheus }}" = "true" ]; then
          echo "ðŸ“Š Sending METRICS to Prometheus via send_data.py script..."
          
          # Convert build status to numeric (1=success, 0=failure)
          BUILD_STATUS_NUMERIC=1
          if [ "${{ inputs.build-status }}" != "success" ]; then
            BUILD_STATUS_NUMERIC=0
          fi
          
          echo "ðŸ Executing Python script with metrics..."
          
          # Check if python is available
          if command -v python3 &> /dev/null; then
            PYTHON_CMD="python3"
          elif command -v python &> /dev/null; then
            PYTHON_CMD="python"
          else
            echo "âŒ Python not found. Installing python3..."
            apt-get update && apt-get install -y python3 python3-pip
            PYTHON_CMD="python3"
          fi
          
          # Install required dependencies if not present
          if ! $PYTHON_CMD -c "import prometheus_remote_writer" 2>/dev/null; then
            echo "ðŸ“¦ Installing prometheus-remote-writer..."
            $PYTHON_CMD -m pip install prometheus-remote-writer
          fi
          
          # Execute the send_data.py script with arguments
          if $PYTHON_CMD ${{ github.action_path }}/send_data.py \
            --app-name "${{ inputs.app-name }}" \
            --app-version "${{ inputs.app-version }}" \
            --environment "${{ inputs.environment }}" \
            --build-status ${BUILD_STATUS_NUMERIC} \
            --vulnerabilities-critical ${{ inputs.vulnerabilities-critical }} \
            --vulnerabilities-high ${{ inputs.vulnerabilities-high }} \
            --vulnerabilities-medium ${{ inputs.vulnerabilities-medium }} \
            --vulnerabilities-low ${{ inputs.vulnerabilities-low }} \
            --code-coverage ${{ inputs.code-coverage }} \
            --execution-time ${{ inputs.execution-time }} \
            --grafana-api-key "${GRAFANA_API_KEY}" \
            --pushgateway-url "${PROMETHEUS_URL}/api/prom/push"; then
            echo "âœ… Metrics sent to Prometheus successfully via Python script"
            PROMETHEUS_STATUS="success"
            METRICS_COUNT=7
          else
            echo "âš ï¸ Prometheus metrics via Python script failed"
            PROMETHEUS_STATUS="failed"
            OVERALL_STATUS="partial"
          fi
        else
          echo "â­ï¸ Prometheus integration disabled"
        fi
        
        # Annotations Integration
        if [ "${{ inputs.enable-annotations }}" = "true" ]; then
          echo "ðŸ“‹ Sending TIMELINE EVENT to Grafana Annotations..."
          ANNOTATIONS_ENDPOINT="${GRAFANA_URL}/api/annotations"
          
          if curl -X POST \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${GRAFANA_API_KEY}" \
            -d '{
              "time": '${TIMESTAMP}'000,
              "timeEnd": '${TIMESTAMP}'000,
              "tags": ["'${{ inputs.app-name }}'", "'${{ inputs.environment }}'", "devsecops", "pipeline"],
              "text": "ðŸš€ DevSecOps Pipeline: '${{ inputs.build-status }}'\nðŸ“± App: '${{ inputs.app-name }}' v'${{ inputs.app-version }}'\nðŸ” Vulns: C:'${{ inputs.vulnerabilities-critical }}' H:'${{ inputs.vulnerabilities-high }}' M:'${{ inputs.vulnerabilities-medium }}' L:'${{ inputs.vulnerabilities-low }}'\nðŸ“Š Coverage: '${{ inputs.code-coverage }}'% | Time: '${{ inputs.execution-time }}'s"
            }' \
            "${ANNOTATIONS_ENDPOINT}" \
            --silent --show-error; then
            echo "âœ… Timeline event sent to Annotations"
            ANNOTATIONS_STATUS="success"
          else
            echo "âš ï¸ Annotations integration failed"
            ANNOTATIONS_STATUS="failed"
            OVERALL_STATUS="partial"
          fi
        else
          echo "â­ï¸ Annotations integration disabled"
        fi
        
        # Output Summary
        echo ""
        echo "ðŸ“Š Grafana Cloud Integration Summary:"
        echo "  ðŸŒ Grafana URL: ${GRAFANA_URL}"
        echo "  ðŸ“± Application: ${{ inputs.app-name }} v${{ inputs.app-version }}"
        echo "  ðŸ·ï¸  Environment: ${{ inputs.environment }}"
        echo "  ðŸš€ Build Status: ${{ inputs.build-status }}"
        echo "  ðŸ” Vulnerabilities: C:${{ inputs.vulnerabilities-critical }}, H:${{ inputs.vulnerabilities-high }}, M:${{ inputs.vulnerabilities-medium }}, L:${{ inputs.vulnerabilities-low }}"
        echo "  ðŸ“Š Coverage: ${{ inputs.code-coverage }}%"
        echo "  â±ï¸  Execution Time: ${{ inputs.execution-time }}s"
        echo ""
        echo "ðŸŽ¯ Integration Status:"
        echo "  ðŸ“ Loki: ${LOKI_STATUS}"
        echo "  ðŸ“Š Prometheus: ${PROMETHEUS_STATUS}"
        echo "  ðŸ“‹ Annotations: ${ANNOTATIONS_STATUS}"
        echo "  ðŸ“ˆ Overall: ${OVERALL_STATUS}"
        echo ""
        
        # Set outputs
        echo "status=${OVERALL_STATUS}" >> $GITHUB_OUTPUT
        echo "loki-status=${LOKI_STATUS}" >> $GITHUB_OUTPUT
        echo "prometheus-status=${PROMETHEUS_STATUS}" >> $GITHUB_OUTPUT
        echo "annotations-status=${ANNOTATIONS_STATUS}" >> $GITHUB_OUTPUT
        echo "metrics-count=${METRICS_COUNT}" >> $GITHUB_OUTPUT

branding:
  icon: 'upload-cloud'
  color: 'orange'
